# Windows privilege escalation

## Checklist
- Key information to leverage :
    - [ ] Username and hostname
    - [ ] Group memeberships of the current user
    - [ ] Existing users and groups
    - [ ] OS version and architecture
    - [ ] Network information
    - [ ] Installed applications
    - [ ] running processes
- [ ] checking the `windows/win.ini` file 
- [ ] searching for any file that may contain a password or secret information by searching for extensions like `*.txt` `*.ini` or `.kdbx`
- [ ] searching for any interesting user file with extensions like : `*.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx`
- [ ] If the user isn't a member of *Remote Desktop Users* or *Remote Management Users* we can't connect to it via RDP or winRM respectively. So we use the *Runas* method from another user if we have the credentials. 
- [ ] Automated tools `winPEAS` 


## Windows privileges and Access control mechanisms
### Security Identifier (SID)
Example:
```
S-1-5-21-1336799502-1441772794-948155058-1001
```
- S : is for indicating that the string is an SID.
- 1 : version of the SID implementation
- 5 : Determines the identifier authority. 5 is the most common and represents the *NT Authority* and is used for local, domain users and groups. 
- the rest : represents the sub-authorities of the identifier authority. domain identifier and relative identifier (RID). 
- 1001 defines that relative identifier. 

### Access Token 
When a user authentifies, an access token is assigned to that user. The token describes various information that defines the *security context*. 

when a user starts a process, a token is assigned to the objects related. This token is called the *primary token* and specifies which permissions the process or threads have when interacting with another object and is a copy of the access token of the user. 

A thread can also have an *impersonate token*. And provides a different security context than the process that owns the thread. 

### Mandatory Integrity Control

Mandatory Integrity are *integrity levels* to control acess to securable objects (hierarchies of trust).

[https://learn.microsoft.com/en-us/windows/win32/secauthz/mandatory-integrity-control](https://learn.microsoft.com/en-us/windows/win32/secauthz/mandatory-integrity-control)

### User Account Control
UAC is a security feature that protects the OS by running most applications with standard user privs. It leverages two tokens, a standard user token, and an administrator token which is the consent prompt on Windows. 

## Windows Enumeration 

### Key informations about a system
#### Get the **username** and **hostname** 
```powershell
whoami
```
#### Listing all the groups a user
```powershell
whoami /groups
```

#### Obtain a list of all local users (show also if enabled with description). 
```powershell
net user
# Or 
Get-LocalUser
```
#### Obtaining a list of all local groups 
```powershell
net localgroup
# Or
Get-LocalGroup
```
#### Listing the members of a group 
```powershell
Get-LocalGroupMember <groupName>
```

#### The OS information can be obtained using 
```powershell
systeminfo
```
#### Network information 
```powershell
ipconfig /all
```
#### Checking Routing table 
```powershell
route print
```
#### showing all active connections 
```powershell
netstat -ano
```
#### Checking installed applications
To list both 32-bit and 64-bit applications we query two registry keys in the *Windows Registry* with the *Get-ItemProperty* Cmdlet :
```powershell
# 32bits
Get-ItemProperty "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname

#64bits
Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
```
This output might not be completed, an additional search should be done on the *Program Files* and *Downloads* directories. 

#### Indentifying running processes

```powershell
Get-Process
```

#### Searching for interesting files 
```powershell
Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue
```

### Switching user with `RunAs`
To change a user that has no access to RDP or WinRM, we can leverage `RunAs` to have a cmd shell with that user :
```powershell
runas /user:<newuser> cmd
```

## Powershell logging information
Powershell uses 2 important logging mechanisms : ***Powershell Transcription*** and ***Powershell Script Block Logging***. 

[https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.host/start-transcript?view=powershell-7.4](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.host/start-transcript?view=powershell-7.4)

### Checking history commands 
#### Checking user history
We use the `Get-History` Cmdlet to check the command history :
```powershell
Get-History
```

#### Checking `PSReadline` history

We first must obtain information from the PSReadline module :
```powershell
(Get-PSReadlineOption).HistorySavePath

C:\Users\<user>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```

We can then read the content of the file which will output the Readline commands made :
```powershell
type C:\Users\<user>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
``` 

#### Script Block Logging 
Event Viewer → Events from ***Script Block Logging*** are in Application and Services → Microsoft → Windows → PowerShell → Operational then search more . Apply filter for 4104 events 

## Leveraging Windows services 

### Hijacking the service binary
Each Windows service has a binary associated to it. If read and write accesses are not secured it is possible to replace it with a malicious one with the privileges of the service (and thus elevating privileges).

#### Showing all running services

```powershell
Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running' }
```

#### File permission enumeration
`icacls` or `Get-ACL`. 

#### methodology of windows service hijack 
If the result of service is full or inherited.  

#### Restarting services
Services are needs administrative permissions to be restart directly. 
However,  if the startup type is set to "Auto" the service can restart by rebooting the machine. 
```powershell
# Viewing the start mode 
Get-CimInstance -ClassName win32_service | Select Name, StartMode | Where-Object {$_.Name -like 'mysql'}

# Rebooting needs SeShutdownPrivilege assigned 
whoami /priv
shutdown /r /t 0 
```


## Unquoted service paths