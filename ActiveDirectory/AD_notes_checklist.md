---
title: 'pentest : AD tips & tricks '
updated: 2024-01-02 22:41:39Z
created: 2023-10-09 19:36:36Z
---

# AD tips & tricks

- Lorsque c'est une machine AD, et que l'on a un site vitrine, toujours penser à tester les usernames pour savoir s'ils sont dans l'AD
- regarder les images s'il n'y a pas des infos à soutirer, ou partout car tout est intéressant à prendre.<
- les paths /certenroll et /certsrv indiquent que le DC doit run le certification authority service ***(késako?)***
- seclists/web-content/ worldlist

## Foothold

Exploiting Active Directory begins when we already have a first user or service access to the machine.  
If we have a front website, always think about the usernames that we can extract from it.  
Every ressource is gold when it comes to extract information. From images to everything inside the front website.

### Information that we must gather

The domain name is important to keep. (even putting it on `/etc/hosts` if we have a web interface available).  
Keeping in mind the name of the host is also important.  
Knowing what we have:

- SMB :  
    \- verifying that we do have it open, that way we know we can use `smbclient` to explore the shared folders as soon as we have a valid user.  
    \- We can also gather the share folders with `smbmap`

It is good practice to know, or to keep in mind that if we have a web interface or web ports open, we could also have internal staff interfaces that we can go to if we have an access.  
To keep in mind:

- That internal platform could be username password
- certificate enabled
- or just vulnerable

## Tools

### Kerbrute

https://github.com/ropnop/kerbrute.git

- We can do pre-auth user testing without necessarily knowing the password.
- We can do password-spray too and bruteforce.

### LDAPDomainDump or more interesting Bloodhound.py

https://github.com/dirkjanm/BloodHound.py  
Using bloodhound.py instead of ldapdomaindump cause it's better for bloodhound usage directly

### Testing the log in with CrackMapExec

https://www.crackmapexec.wiki/getting-started/using-kerberos  
CME isn't just for testing to log in to the machine. It has way more interesting stuff to offer.  
What's also interesting is that we can use it with multiple protocols.  
Spider plus CME : we can list all the subdirectories with spider plus on smb which is really interesting.

The idea is that each time we have a user, we can look if it can give us a shell pretty much, we cme using winrm .

## Discovering new accounts and information gathering

### Going through the bloodhound.py results

We can enumerate things with the jq tooling.

```bash
$ cat users.json | jq .  
cat users.json | jq 'keys' # available keys
cat users.json | jq '.data' # struture inside the data key
cat users.json | jq '.data[]' | head # removing the brackets 
cat users.json | jq '.data[].Properties | select(.enabled==true) | .name' -r > users_email.txt # extracting the emails.
cat users.json | jq '.data[].Properties | select(.enabled==true) | .name' -r| cut -f 1 -d @ # Removing what's after @ 
```

### Exploring the SPNs

getUserSPNs can give us the user SPNs available as service account.  
the idea is to extract the hash, and crack it with hashcat or something else.

### Trying to find more users through password spraying

> the idea is to test all this users with a technique called passwordspray.

By using kerbrute and passwordspraying option, we can test all the users if the have the same password as those we found. especially if it concerns a service account.

```bash
kerbrute passwordspray --cd 10.10.11.129 -d search.htb all_users.txt "password"
```

This can give us more valid users that we could use after.

### Testing for shell

We our valid users and passwords, we can test for shell using crackmapexec:

```bash
# with smb
$ crackmapexec smb 10.10.11.129 -u valid_users.txt -p valid_pws.txt --no-bruteforce --continue-on-success

# with winrm (if port 5985,5986 are closed,getting an access could be impossible this way)
$ crackmapexec winrm 10.10.11.129 -u valid_users.txt -p valid_pws.txt --no-bruteforce --continue-on-success
```

### Listing the share with the user we got

Using Using crackmapexec with the `spider_plus` module, we can get a tree of the SMB shared folders.  
It is effective in a sense where it gives all the branches that we have access to, so that we can have a a better overview of the target machine. Example :

```bash
$ crackmapexec smb -u username -p password -M spider_plus
# the output will be in /tmp/date.json
```

We can then move through the file with `jq`:

```bash
# listing the shared folders and values
$ cat spider_plus_dump.json | jq 'map_values(keys)'
```

![9dabad6ba2484d484c88624c490c7d6a.png](./9dabad6ba2484d484c88624c490c7d6a.png)

### When a user is owned

each time a user is owned (or we have a suspicion that we can own it), we can signal it in bloodhound and search for the shortest path to admin. It will give us the path on how to move to get to what we want.

## Password cracking in Active Directory

The types of hashes that we can encounter in an AD are similar to those on windows (obviously I guess).  
Which means, NTLM and kerberos.

## Reverse-shells in Active Directory (more specifically, Windows)

https://github.com/samratashok/nishang

We can have multiple issues with defender when trying uploading a reverse-shell. Most importantly, it can be blocked on powershell (and other for that matter).  
First we must a powershell reverse-shell command then, if it's blocked :

- renaming variable names
- removing obvious string such as "PS >"
- ... (obfuscating a little bit)

## Enumerating all Active Directory attacks

### kerberoasting

some notes : A user account is being used as a service because the property 'ServicePrincipalName' is not null.  
For kerberoasting with need,

- a domain account that can request for TGSs (ticket granting service)
- need valid credentials inside the domain

#### Get users SPNs

## Misc

- cracking passwords for protected sheets files  
    https://theolucia.medium.com/how-to-remove-decrypt-crack-forgotten-excel-password-1ccdde65a4d0

## Refs

- Search HackTheBox
