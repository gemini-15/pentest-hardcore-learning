# AD authentication Attacks 

## Active Directory Authentication 

### Cached credentials in Kerberos
Microsoft's implementation of kerberos makes use of single sign-on, so passwords hashes must be stored somewhere in order to renew a TGT request. 

in modern versions, it is stored in the *local security authority subsystem (LSASS)* memory.

- ***We need SYSTEM (or local administrator) permissions to get access to the stored hashes on a target.***
- To extract the hashes we use *Mimikatz*
- Because of its well known detection signatures, we should execute mimikatz from memory using an injector like Powershell to avoid AV.
- We can also use a built-in tool like Task Manager to dump the entire LSASS and then load the data into mimikatz on a different machine.
- With Mimikatz, we can export tickets to a persistent storage or import keys. 

## Attacks on Active Directory Authentication

### Password attacks
#### Password spraying 

### AS-REP Roasting 
As a recall, the first step of the authentication process via kerberos is to send an AS-REQ. 
Based on the request, the DC validates if the authentication is a success. 
**If it is**, the DC replies with an AS-REP containing the session key and the TGT. 
This step is known as **kerberos Preauthentication** and prevents offline passwords guessing. 

We can use an AS-REP attack when required preauth option is disabled. 

#### using impacket with `impacket-GetNPUsers`



#### Obtaining the lockout policy
We must always take into account lockouts when performing brute-force attacks or wordlsit auth attack. 
To obtain the lockout policy we can run the following: 
```powershell
net accounts
```
Looking at the following lines : 
```
Lockout threshold:                                    5
Lockout duration (minutes):                           30
Lockout observation window (minutes):                 30
```
We can try 4 times before we have to wait the observation window time to try again. 

