# AD authentication Attacks 

## Active Directory Authentication 

### Cached credentials in Kerberos
Microsoft's implementation of kerberos makes use of single sign-on, so passwords hashes must be stored somewhere in order to renew a TGT request. 

in modern versions, it is stored in the *local security authority subsystem (LSASS)* memory.

- ***We need SYSTEM (or local administrator) permissions to get access to the stored hashes on a target.***
- To extract the hashes we use *Mimikatz*
- Because of its well known detection signatures, we should execute mimikatz from memory using an injector like Powershell to avoid AV.
- We can also use a built-in tool like Task Manager to dump the entire LSASS and then load the data into mimikatz on a different machine.
- With Mimikatz, we can export tickets to a persistent storage or import keys. 

## Attacks on Active Directory Authentication

### Password attacks
#### Password spraying 
TODO:
#### Obtaining the lockout policy
We must always take into account lockouts when performing brute-force attacks or wordlsit auth attack. 
To obtain the lockout policy we can run the following: 
```powershell
net accounts
```
Looking at the following lines : 
```
Lockout threshold:                                    5
Lockout duration (minutes):                           30
Lockout observation window (minutes):                 30
```
We can try 4 times before we have to wait the observation window time to try again. 

### AS-REP Roasting 
As a reminder, the first step of the authentication process via kerberos is to send an AS-REQ. 
Based on the request, the DC validates if the authentication is a success. 
**If it is**, the DC replies with an AS-REP containing the session key and the TGT. 
This step is known as **kerberos Preauthentication** and prevents offline passwords guessing. 

We can use an AS-REP attack when required preauth option is disabled. 

#### using impacket with `impacket-GetNPUsers`
The Output file can be used directly with `Hashcat`. 

```bash
impacket-GetNPUsers -dc-ip <Domain-controller-IP>  -request -outputfile hashes.asreproast domain.com/username
```
#### using Rubeus on windows
source : [https://github.com/GhostPack/Rubeus](https://github.com/GhostPack/Rubeus)

Leveraging the AS-REP roast attack with Rubeus in Windows is as straight forward as the following: 
```powershell
.\Rubeus.exe asreproast /nowrap
```
It will display the AS-REP hash in Hashcat format. 

#### Note
- [ ] If we have a user with ***GenericWrite*** or ***GenericAll*** permissions, instead of renewing the password, we could **leverage these permissions to modify the User Account Control value of the user to not require a Kerberos preauth.** This Attack is known as ***Targeted AS-REP Roasting***. 
### Kerberoasting 
When requesting the service ticket from the domain controller, no checks are performed to confirm if the user has any permissions to access the service hosted by the Service Principal Name (SPN). 

These checks are done when connecting to the service. Thus, if we know the SPN that we want to target, we can request a service ticket for it from the DC. 

The service ticket is encrypted using the SPN's password hash. If we are able to decrypt it we can use this information to crack to password of the service account. This attack is known as ***Kerberoasting***. 
#### Obtaining the TGS-REP using Impacket 

```bash
sudo impacket-GetUserSPNs -request -dc-ip <Domain-controller-IP> example.com/username
```

#### Obtaining the TGS-REP using Rubeus on windows 
```powershell
.\Rubeus.exe kerberoast /outfile:hashes.kerberoast
```

#### Note 
- [ ] If the SPN runs in the context of a computer account, a managed service account, or group-managed service account, the password is randomly generated and long that will make the cracking unoperable. Same thing with the *krbtgt* user account which is the service account for the KDC. 
- [ ] A user with *GenericWrite* or *GenericAll* could also set an SPN for the user, kerberoast the account and crack the password (***targeted Kerberoasting***), this will avoid the suspicious reset of a user's password. 

### Silvertickets

The application on the server executing in the context of the service account checks the user's permissiosn from the group memberships included in the service ticket. However, the user and group permissions in the service ticket are not verified by the application in a majority of environments. 


### Domain Controller Synchronisation
The *Directory Replication Service (DRS)* Remote protocol uses replication to synchronise the redundant domain controllers. 
A domain controller may request an update for a specific object like an account, using the `IDL_DRSGetNCChanges` API. 
The Domain controller receiving this request does not check if the request came from a known domain controller, it only verifies the SID has the appropriate privileges. 

To launch a replication , a user needs to have Replicating Directory Changes, Replicating Directory Changes All, and Replicating Directory Changes in Filtered Set rights. By default, members of the Domain Admins, Enterprise Admins, and Administrators groups have these rights assigned.

If we have a user on these groups we can perform a *dcsync* attack in which we impersonate a domain controller => we could request any user credentials from the domain. 

#### Using mimikatz
```powershell
mimikatz # lsadump::dcsync /user:corp\Administrator
```

#### Using impacket on Linux 
```bash
impacket-secretsdump -just-dc-user <user requested> example.com/adminaccount:"supersecretpassword"@<DC-IP>
```
